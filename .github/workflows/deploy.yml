name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js app
        run: npm run build
        env:
          NODE_ENV: production
          # NEXT_PUBLIC_* variables are embedded at build time and need to be available during build
          NEXT_PUBLIC_TURNSTILE_SITE_KEY: ${{ secrets.NEXT_PUBLIC_TURNSTILE_SITE_KEY }}
          NEXT_PUBLIC_GTM_ID: ${{ secrets.NEXT_PUBLIC_GTM_ID }}

      - name: Create deployment package
        run: |
          mkdir -p deploy
          cp -r .next deploy/
          cp -r public deploy/
          cp -r src deploy/
          cp -r messages deploy/
          cp -r fonts_to_use_for_ar deploy/ 2>/dev/null || true
          cp package.json deploy/
          cp package-lock.json deploy/
          cp next.config.mjs deploy/
          cp tsconfig.json deploy/
          cp postcss.config.js deploy/
          cp .env.example deploy/

      - name: Compress deployment package
        run: |
          tar -czf deploy.tar.gz -C deploy .

      - name: Deploy to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT || 22 }}
          source: "deploy.tar.gz"
          target: "/root/portfolio-deploy"
          strip_components: 0

      - name: Extract and deploy on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT || 22 }}
          script: |
            set -e
            
            echo "ğŸš€ Starting automated deployment..."
            
            cd /root/portfolio-deploy
            
            # Extract deployment package
            echo "ğŸ“¦ Extracting deployment package..."
            tar -xzf deploy.tar.gz
            rm deploy.tar.gz
            
            # Create app directory if it doesn't exist
            mkdir -p /var/www/portfolio
            
            # Backup current deployment
            if [ -d /var/www/portfolio/.next ]; then
              echo "ğŸ’¾ Creating backup..."
              BACKUP_DIR="/var/www/portfolio.backup.$(date +%Y%m%d_%H%M%S)"
              mkdir -p "$BACKUP_DIR"
              cp -r /var/www/portfolio/.next "$BACKUP_DIR/" 2>/dev/null || true
              cp -r /var/www/portfolio/public "$BACKUP_DIR/" 2>/dev/null || true
              cp -r /var/www/portfolio/src "$BACKUP_DIR/" 2>/dev/null || true
              cp -r /var/www/portfolio/messages "$BACKUP_DIR/" 2>/dev/null || true
              cp /var/www/portfolio/package.json "$BACKUP_DIR/" 2>/dev/null || true
              echo "âœ… Backup created at $BACKUP_DIR"
            fi
            
            # Copy new files
            echo "ğŸ“‹ Copying files..."
            cp -r .next /var/www/portfolio/
            cp -r public /var/www/portfolio/
            cp -r src /var/www/portfolio/
            cp -r messages /var/www/portfolio/
            [ -d fonts_to_use_for_ar ] && cp -r fonts_to_use_for_ar /var/www/portfolio/ || true
            cp package.json /var/www/portfolio/
            cp package-lock.json /var/www/portfolio/
            cp next.config.mjs /var/www/portfolio/
            cp tsconfig.json /var/www/portfolio/
            cp postcss.config.js /var/www/portfolio/
            
            # Handle environment file
            if [ -f /var/www/portfolio/.env ]; then
              echo "âœ… Keeping existing .env file"
            else
              if [ -f .env.example ]; then
                cp .env.example /var/www/portfolio/.env
                echo "âš ï¸  Created .env from .env.example - PLEASE CONFIGURE IT!"
              else
                echo "âš ï¸  No .env file found - you need to create one manually"
              fi
            fi
            
            # Install production dependencies
            echo "ğŸ“¦ Installing dependencies..."
            cd /var/www/portfolio
            npm ci --production --no-audit
            
            # CRITICAL FIX: Use port 3001 to avoid conflict with nghttpx on port 3000
            echo "ğŸ” Checking port 3001 availability..."
            PORT_3001_PID=$(lsof -ti :3001 2>/dev/null || echo "")
            if [ -n "$PORT_3001_PID" ]; then
              PORT_3001_PROCESS=$(ps -p $PORT_3001_PID -o comm= 2>/dev/null || echo "")
              echo "   âš ï¸  Port 3001 is in use by: $PORT_3001_PROCESS (PID: $PORT_3001_PID)"
              echo "   Stopping PM2 portfolio process first..."
              pm2 stop portfolio 2>/dev/null || true
              pm2 delete portfolio 2>/dev/null || true
              sleep 2
            else
              echo "   âœ… Port 3001 is available"
            fi
            
            # Setup PM2 - ALWAYS stop/delete first to avoid conflicts
            echo "âš™ï¸  Configuring PM2..."
            if pm2 list | grep -q "portfolio"; then
              echo "   Stopping existing portfolio process..."
              pm2 stop portfolio 2>/dev/null || true
              pm2 delete portfolio 2>/dev/null || true
              sleep 2
            fi
            
            echo "ğŸ†• Starting new PM2 process..."
            # Use port 3001 to avoid conflict with nghttpx on port 3000
            PORT=3001 pm2 start npm --name "portfolio" -- start
            pm2 save
            
            # Setup PM2 startup if not already done
            pm2 startup systemd -u root --hp /root 2>/dev/null || echo "   PM2 startup already configured"
            
            # Wait for app to start
            echo "â³ Waiting for application to start..."
            sleep 5
            
            # Health check - verify app is running
            echo "ğŸ¥ Performing health check..."
            MAX_RETRIES=15
            RETRY_COUNT=0
            APP_ONLINE=false
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              # Check PM2 status
              if pm2 list | grep -q "portfolio.*online"; then
                # Try to curl the app
                if curl -f -s http://localhost:3001 > /dev/null 2>&1; then
                  APP_ONLINE=true
                  break
                else
                  echo "   PM2 shows online but app not responding on port 3001..."
                  # Check what's actually on port 3001
                  PORT_3001_PID=$(lsof -ti :3001 2>/dev/null || echo "")
                  if [ -n "$PORT_3001_PID" ]; then
                    PORT_3001_PROCESS=$(ps -p $PORT_3001_PID -o comm= 2>/dev/null || echo "")
                    echo "   Port 3001 is being used by: $PORT_3001_PROCESS (PID: $PORT_3001_PID)"
                  fi
                fi
              else
                # Check PM2 error logs
                PM2_STATUS=$(pm2 jlist | grep -A 5 '"name":"portfolio"' | grep -o '"status":"[^"]*"' | cut -d'"' -f4 || echo "unknown")
                echo "   Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES - PM2 status: $PM2_STATUS"
                if [ "$PM2_STATUS" = "errored" ] || [ "$PM2_STATUS" = "stopped" ]; then
                  echo "   Checking error logs..."
                  pm2 logs portfolio --lines 10 --nostream 2>&1 | tail -5
                fi
              fi
              RETRY_COUNT=$((RETRY_COUNT + 1))
              sleep 2
            done
            
            if [ "$APP_ONLINE" = true ]; then
              echo "âœ… Application is running and responding on port 3001"
            else
              echo "âŒ ERROR: Application failed to start or is not responding"
              echo ""
              echo "ğŸ“‹ Diagnostic Information:"
              echo "   PM2 Status:"
              pm2 list | grep portfolio || echo "   Portfolio process not found"
              echo ""
              echo "   Port 3001 Status:"
              lsof -i :3001 2>/dev/null || echo "   Port 3001 not in use"
              echo ""
              echo "   Recent PM2 Logs:"
              pm2 logs portfolio --lines 20 --nostream 2>&1 | tail -20
              echo ""
              echo "   Please check the logs above and fix any issues before continuing."
              exit 1
            fi
            
            # Verify OpenLiteSpeed reverse proxy configuration
            echo "ğŸŒ Verifying OpenLiteSpeed reverse proxy configuration..."
            VHOST_CONF="/usr/local/lsws/conf/vhosts/abdeljawad.com/vhost.conf"
            
            if [ -f "$VHOST_CONF" ]; then
              # Check if proxy config is correctly set up for port 3001
              if grep -q "address 127.0.0.1:3001" "$VHOST_CONF" 2>/dev/null || grep -q "address localhost:3001" "$VHOST_CONF" 2>/dev/null; then
                echo "   âœ… OpenLiteSpeed reverse proxy is correctly configured for port 3001"
                # Reload OpenLiteSpeed to ensure config is active
                /usr/local/lsws/bin/lswsctrl reload
                echo "   âœ… OpenLiteSpeed reloaded"
              else
                echo "   âš ï¸  Warning: OpenLiteSpeed config may not be set up for port 3001"
                echo "   Current config exists but proxy may not be configured correctly"
                echo "   Please verify manually: $VHOST_CONF"
                echo "   Expected: context / with type proxy and address 127.0.0.1:3001"
              fi
            else
              echo "   âš ï¸  Warning: OpenLiteSpeed config file not found at $VHOST_CONF"
              echo "   OpenLiteSpeed may need manual configuration"
            fi
            
            # Cleanup old backups (keep last 3)
            echo "ğŸ§¹ Cleaning up old backups..."
            cd /var/www
            if [ -d portfolio.backup.* ]; then
              ls -dt portfolio.backup.* 2>/dev/null | tail -n +4 | xargs rm -rf 2>/dev/null || true
            fi
            
            # Ensure public_html is empty (OpenLiteSpeed proxy requires empty docRoot)
            echo "ğŸ“ Ensuring public_html is empty for proxy to work..."
            # Remove any files that might interfere with proxy
            rm -f /home/abdeljawad.com/public_html/index.html /home/abdeljawad.com/public_html/index.php 2>/dev/null || true
            # Keep only symlinks to static assets if they exist
            find /home/abdeljawad.com/public_html -type f ! -type l -delete 2>/dev/null || true
            echo "   âœ… public_html cleaned (proxy will handle all requests)"
            
            # Cleanup deployment directory
            cd /root
            rm -rf portfolio-deploy
            
            echo ""
            echo "âœ… Deployment completed successfully!"
            echo ""
            echo "ğŸ“Š Application Status:"
            pm2 list | grep portfolio || echo "   (Check manually: pm2 status)"
            echo ""
            echo "ğŸŒ Domain: https://abdeljawad.com"
            echo "ğŸ“ Logs: pm2 logs portfolio"
            echo "ğŸ”„ Restart: pm2 restart portfolio"
